# 📸 Google Vision API 영수증 스캔 가이드

## ✨ 시스템 개요

하이콘 코리아 직원 관리 시스템의 **영수증 자동 스캔 기능**은 Google Vision AI와 수동 입력을 결합한 **하이브리드 시스템**입니다.

### 🎯 작동 방식

```
영수증 사진 업로드
    ↓
① Google Vision API 자동 인식 시도
    ↓
  성공? ─ YES → ✅ 자동 입력 완료 (날짜/상호/금액)
    │
    NO
    ↓
② 수동 입력 모드로 자동 전환
    ↓
  - 왼쪽: 영수증 사진 미리보기
  - 오른쪽: 수동 입력 폼
  - 상호명 자동완성 지원 (최근 13개)
    ↓
③ 확인/수정 후 저장
```

---

## 🔑 API 키 설정

### **1단계: Google Cloud에서 API 키 발급**

```bash
1. https://console.cloud.google.com 접속
   └─ Google 계정 로그인

2. 프로젝트 생성
   └─ "새 프로젝트" 클릭
   └─ 이름: "하이콘-영수증-스캔"

3. Cloud Vision API 활성화
   └─ 왼쪽 메뉴: "API 및 서비스" → "라이브러리"
   └─ 검색: "Cloud Vision API"
   └─ "사용 설정" 클릭 ✅

4. API 키 생성
   └─ "API 및 서비스" → "사용자 인증 정보"
   └─ "사용자 인증 정보 만들기" → "API 키"
   └─ 📋 생성된 키 복사
   └─ 형식: AIzaSyC_xxxxxxxxxxxxxxxxxxxxxxxxxxxxx (39자)
```

### **2단계: Supabase에 API 키 등록**

```bash
1. https://supabase.com/dashboard 접속

2. 프로젝트 선택
   └─ 하이콘 코리아 대시보드

3. 환경 변수 설정
   └─ ⚙️ Project Settings
   └─ Edge Functions
   └─ Secrets (환경 변수 섹션)

4. 새 Secret 추가
   Name:  GOOGLE_VISION_API_KEY
   Value: AIzaSyC_xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
   └─ "Save" 클릭 ✅

5. Edge Function 자동 재시작됨 🚀
```

---

## ✅ 테스트 방법

### **API 키 상태 확인**

1. **직원 관리** 페이지 접속
2. **"직원 지출 내역"** 탭 클릭
3. **"📸 영수증 스캔"** 버튼 클릭
4. **"🔍 Google Vision API 연결 상태 확인"** 버튼 클릭

**예상 결과:**

```
✅ 성공 (실제 API 키)
   "Google Vision API 키가 정상적으로 설정되었습니다!"
   키: AIzaSyCXX...XXXX
   → 실제 영수증 자동 인식 작동! 🚀

🎭 Mock 모드 (테스트 키: 0716)
   "Mock OCR 모드가 활성화되었습니다!"
   → 자동 인식 시뮬레이션 작동! (3가지 샘플 영수증)
   → 실제 서비스 전 기능 테스트용

❌ 실패 (키 없음)
   "GOOGLE_VISION_API_KEY가 설정되지 않았습니다."
```

---

### **영수증 스캔 테스트**

#### **✨ Mock 모드 (테스트 키: 0716) - 추천!**

```
1. "파일 선택" 또는 카메라로 아무 사진이나 업로드
2. 자동 인식 중... (즉시 완료)
3. 결과:
   🎭 "영수증 자동 인식 완료! (Demo 모드)"
   
   자동 생성된 샘플 데이터 (3가지 중 랜덤):
   
   ① 춘천만송
      - 날짜: 2025-04-06
      - 금액: 120,000원
   
   ② 조이에스넷
      - 날짜: 2025-05-14
      - 금액: 52,000원
   
   ③ 커피소망리
      - 날짜: 2025-06-22
      - 금액: 13,000원

4. 확인/수정 후 "💾 저장" 클릭
5. 여러 번 테스트하면 다른 샘플 확인 가능!

💡 용도: 실제 서비스 전 기능 시연 및 테스트
```

#### **🚀 실제 자동 인식 (실제 API 키: AIzaSy...)**

```
1. "파일 선택" 또는 카메라로 실제 영수증 촬영
2. 자동 인식 중... (5~10초)
3. 결과:
   ✅ "영수증 자동 인식 완료! (Vision AI)"
   
   실제 영수증에서 자동 추출된 데이터:
   - 날짜: 영수증에 인쇄된 날짜
   - 상호: 가게 이름
   - 금액: 합계 금액
   - 카테고리: 🍴 식비 (기본값)

4. 확인/수정 후 "💾 저장" 클릭

💡 용도: 실제 운영 환경
```

#### **⚠️ 수동 입력 모드 (API 실패 시 자동 전환)**

```
1. 영수증 업로드
2. 자동 인식 실패 (네트워크 에러 등)
3. 결과:
   ⚠️ "자동 인식 실패. 사진을 보며 직접 입력해주세요."
   
   화면 구성:
   ┌─────────────────────────────────────────┐
   │ 왼쪽: 영수증 사진 미리보기              │
   │ 오른쪽: 수동 입력 폼                    │
   │   - 날짜 선택 (캘린더)                  │
   │   - 상호명 (자동완성 지원)              │
   │   - 금액                                │
   │   - 카테고리                            │
   │   - 메모 (선택)                         │
   └─────────────────────────────────────────┘

4. 사진 보면서 직접 입력
5. "💾 저장" 클릭

💡 용도: Vision API 에러 시 백업 모드
```

---

## 🔍 디버깅 가이드

### **브라우저 콘솔 (F12)**

#### **✅ 자동 인식 성공 시:**

```javascript
=== 영수증 스캔 시작 (Google Vision API) ===
파일명: receipt.jpg
파일 크기: 523.45 KB
Base64 변환 완료

✅ Vision API 성공!
인식된 텍스트:
 춘천만송
 2025/04/06 18:43:12
 합계 120,000원
 카드승인
 ...

=== 영수증 데이터 추출 시작 (Vision AI) ===
✅ 추출된 날짜: 2025-04-06
✅ 추출된 금액: 120000
✅ 추출된 상호: 춘천만송
```

#### **⚠️ 수동 입력 모드 전환 시:**

```javascript
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⚠️ Vision AI 자동 인식 불가 → 수동 입력 모드
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
💡 영수증 사진을 보면서 직접 입력할 수 있습니다.
💡 실제 Google Vision API 키가 필요하면:
   1. https://console.cloud.google.com
   2. Cloud Vision API 활성화
   3. API 키 생성 (AIzaSy로 시작)
   4. Supabase → Secrets에 등록
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 💰 비용 안내

### **Google Vision API 무료 할당량**

| 항목 | 무료 할당량 | 초과 비용 |
|------|------------|----------|
| DOCUMENT_TEXT_DETECTION | **월 1,000건** | $1.50 / 1,000건 |

### **예상 사용량 (하이콘 코리아)**

```
직원 30명 × 월 10회 영수증 = 300건/월
→ 무료 할당량 내 ✅
```

---

## 🎯 테스트 시나리오

### **시나리오 1: Mock 모드로 기능 체험 (현재 상태 - 추천!)**

```bash
1. API 키: "0716" (테스트용, 이미 설정됨)
2. "🔍 연결 상태 확인" 클릭
   → 🎭 "Mock OCR 모드가 활성화되었습니다!"
3. 영수증 업로드 (아무 사진이나 OK)
   → ✅ 자동 인식 성공! (Mock 데이터)
   → 샘플 영수증 자동 생성 (3가지 중 랜덤)
   
   1회 스캔: 춘천만송 120,000원 ✅
   2회 스캔: 조이에스넷 52,000원 ✅
   3회 스캔: 커피소망리 13,000원 ✅
   4회 스캔: (랜덤 반복)
   
4. 자동 추출 확인
   → 날짜/상호/금액 자동 입력됨 ✅
5. 수정 후 저장
   → 💾 지출 내역에 추가됨 ✅

결론: 자동 인식 기능 완벽 시뮬레이션! 실제 서비스 전 기능 확인 완료!
```

### **시나리오 2: 실제 API 키로 실제 영수증 인식 (운영 환경)**

```bash
1. Google Cloud에서 실제 API 키 발급
   → https://console.cloud.google.com
   → Cloud Vision API 활성화
   → API 키 생성: AIzaSyC_xxxxx... (39자)
   
2. Supabase Secrets에 등록
   → Project Settings → Edge Functions → Secrets
   → Name: GOOGLE_VISION_API_KEY
   → Value: AIzaSyC_xxxxx...
   → Save ✅
   
3. "🔍 연결 상태 확인" 클릭
   → ✅ "정상적으로 설정되었습니다!"
   → 키: AIzaSyCXX...XXXX
   
4. 실제 영수증 촬영 및 업로드
   → ✅ 자동 인식 성공! (Google Vision AI)
   → 실제 영수증 내용 자동 추출
   
5. 확인/수정 후 저장
   → 💾 지출 내역에 추가됨

결론: Vision AI 완벽 작동! 실제 운영 준비 완료!
```

---

## 🚨 FAQ

### **Q1. 테스트 키로 자동 인식이 되나요?**

**A:** 네! **Mock 모드**로 자동 인식을 시뮬레이션할 수 있습니다! 🎭

**현재 상태 (테스트 키: `0716`):**
- ✅ 자동 인식 작동! (3가지 샘플 영수증 랜덤 생성)
- ✅ 날짜/상호/금액 자동 추출
- ✅ 실제 서비스 전 기능 시연 가능
- ✅ Google Vision API 비용 없음

**실제 API 키가 필요한 경우:**
- 실제 영수증 내용을 자동 인식하고 싶을 때
- 운영 환경에서 사용할 때

---

### **Q2. 자동 인식이 항상 실패합니다**

**체크리스트:**

```bash
☐ API 키가 설정되어 있는가?
   → Supabase → Secrets 확인

☐ API 키 형식이 올바른가?
   → AIzaSy로 시작하는 39자 문자열

☐ Cloud Vision API가 활성화되어 있는가?
   → Google Cloud Console 확인

☐ 영수증 사진 품질이 좋은가?
   → 선명한 사진, 충분한 해상도
```

---

### **Q3. 수동 입력 모드가 더 편한데요?**

**A:** 괜찮습니다! 수동 입력 모드는 완전히 독립적으로 작동합니다.

**장점:**
- 🖼️ 영수증 사진 미리보기
- 🔍 상호명 자동완성 (최근 13개)
- 📅 캘린더 날짜 선택
- 💾 영수증 사진도 함께 저장

Vision API 없이도 모든 기능 사용 가능! ✅

---

### **Q4. API 키를 교체하려면?**

```bash
1. Supabase 대시보드 접속
2. Project Settings → Edge Functions → Secrets
3. GOOGLE_VISION_API_KEY 찾기
4. 편집 (연필 아이콘) 클릭
5. 새 값 입력 → Save
6. Edge Function 자동 재시작
```

---

## 📊 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                    프론트엔드 (React)                        │
│  /components/StaffManagementPage.tsx                        │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  1. 영수증 사진 업로드                                │   │
│  │  2. Base64 변환                                       │   │
│  │  3. 서버 API 호출                                     │   │
│  └──────────────────────────────────────────────────────┘   │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ↓ HTTPS
┌───────────────────────────┴─────────────────────────────────┐
│              서버 (Supabase Edge Function)                   │
│  /supabase/functions/server/index.tsx                       │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  1. API 키 환경 변수 로드                             │   │
│  │  2. API 키 형식 검증                                  │   │
│  │  3. Google Vision API 호출                            │   │
│  │  4. 에러 처리 및 응답                                 │   │
│  └──────────────────────────────────────────────────────┘   │
└───────────────────────────┬─────────────────────────────────┘
                            │
                            ↓ HTTPS
┌───────────────────────────┴─────────────────────────────────┐
│          Google Cloud Vision API                             │
│  https://vision.googleapis.com/v1/images:annotate           │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  1. DOCUMENT_TEXT_DETECTION                           │   │
│  │  2. 한국어/영어 지원                                  │   │
│  │  3. 고정밀 OCR 처리                                   │   │
│  │  4. 텍스트 반환                                       │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 🚀 실제 서비스 전환 가이드

### **언제 전환해야 하나요?**

| 상황 | Mock 모드 | 실제 Vision API |
|------|----------|----------------|
| 기능 시연 | ✅ 추천 | ❌ 불필요 |
| 직원 교육 | ✅ 추천 | ❌ 불필요 |
| 프로토타입 테스트 | ✅ 추천 | ❌ 불필요 |
| 실제 운영 | ❌ 부적합 | ✅ 필수 |
| 실제 영수증 인식 | ❌ 불가능 | ✅ 필수 |

---

### **📝 전환 체크리스트**

#### **1단계: 운영 결정**

```
☐ 30명 직원이 실제 영수증을 사용할 준비가 되었나요?
☐ 월 300건 이하 사용 예정인가요? (무료 할당량)
☐ Google Cloud 계정을 생성할 수 있나요?
```

**모두 YES → 2단계로 진행**

#### **2단계: API 키 발급 (10분 소요)**

```bash
1. https://console.cloud.google.com
2. 프로젝트 생성: "하이콘-영수증-스캔"
3. Cloud Vision API 활성화
4. API 키 생성 → 복사
```

#### **3단계: Supabase 설정 (1분 소요)**

```bash
1. https://supabase.com/dashboard
2. Project Settings → Edge Functions → Secrets
3. GOOGLE_VISION_API_KEY 편집
4. 새 API 키 붙여넣기 → Save
```

#### **4단계: 작동 확인 (1분 소요)**

```bash
1. 직원 관리 → 직원 지출 내역
2. 📸 영수증 스캔
3. 🔍 연결 상태 확인
   → ✅ "정상적으로 설정되었습니다!"
4. 실제 영수증 촬영 및 업로드
   → ✅ "영수증 자동 인식 완료! (Vision AI)"
```

**✅ 완료! 실제 서비스 시작!**

---

### **💡 전환하지 않아도 괜찮습니다!**

**Mock 모드만으로도 다음이 가능합니다:**
- ✅ 영수증 사진 업로드 및 저장
- ✅ 자동 인식 시뮬레이션 (기능 시연)
- ✅ 수동 입력 모드 (사진 보며 직접 입력)
- ✅ 상호명 자동완성
- ✅ 지출 내역 관리

**실제 영수증 내용을 자동으로 추출하고 싶을 때만 전환하세요!**

---

## 🎉 결론

**현재 상태:**
- ✅ Mock OCR 모드 구현 완료 (자동 인식 시뮬레이션)
- ✅ 실제 Vision API 연동 준비 완료
- ✅ 하이브리드 시스템 (자동/수동 병행)
- ✅ API 키 형식 검증
- ✅ 에러 처리 개선
- ✅ 사용자 친화적 안내
- ✅ 수동 입력 모드 자동 전환
- ✅ 영수증 사진 미리보기
- ✅ 상호명 자동완성

**지금 바로 사용 가능:**
- **테스트 키 (`0716`)**: Mock 자동 인식 시뮬레이션 ✅
- **실제 API 키**: 실제 영수증 자동 인식 ✅

**전환 방법:**
1. Google Cloud에서 API 키 발급 (10분)
2. Supabase Secrets에 등록 (1분)
3. 즉시 사용 가능! 🚀

**실제 서비스가 필요할 때 언제든지 요청하세요!** 😊
